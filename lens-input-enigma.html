<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../iron-input/iron-input.html'>
<link rel='import' href='../iron-selector/iron-selector.html'>

<!--
An input component that imports data from <a href='http://enigma.io'>Enigma</a>


##### Example

    <lens-input-enigma apiKey='YOURAPIKEY' dataSet='us.gov.whitehouse.visitor-list'></lens-input-enigma>

@homepage http://lenses.github.io/lens-input-enigma
@demo
-->

<dom-module name='lens-input-enigma' attributes='url apiKey dataSet'>

  <template>
    <link rel='stylesheet' href='lens-input-enigma.css'>

      <div class='lens-container lens-input'>

        <div class='controls'>
          <div class='row'>
            <label>API Key:</label> 
            <input is='iron-input' class='long-input' value='{{apiKey}}'>
          </div>
          <div class='row'> 
            <label>Dataset:</label>
            <input is='iron-input' class='long-input' value='{{dataSet}}'>
          </div>


          <template is="dom-if" if='{{_errorMsg}}'>
            <div class='error_msg'>Error: <span>{{_errorMsg}}</span></div>
          </template>
          <div class='selection'>
            <label for='columns_selector'>Select column:</label>

            <iron-selector id='columns_selector' attr-for-selected='label' selected='{{_selectedCols}}'>
                <template is="dom-repeat" items='{{_columns}}'>
                  <div class='col' label='{{item.id}}'>{{item.label}}<template if={{item.type=='type_numeric'}}><span class='numeric'>Numeric</span></template></div>
                </template>
            </iron-selector>

          </div>

          <div class='selection'>
            <label for='func_selector'>Select function:</label>

            <iron-selector id='func_selector' selected='{{_selectedFunc}}' attr-for-selected='label'>
                  <div class='col' label='frequency'>Frequency</div>
                  <div class='col' label='sum'>Sum</div>
                  <div class='col' label='avg'>Average</div>
                  <div class='col' label='stddev'>Standard Deviation</div>
                  <div class='col' label='variance'>Variance</div>
                  <div class='col' label='max'>Max</div>
                  <div class='col' label='min'>Min</div>
            </iron-selector>

          </div>
          <button id='query_data' on-click='_queryStatData'>query data</button>

        </div> <!-- controls -->

  </div> <!-- end container -->
 
  </template>

</dom-module>

  <script>

      Polymer({

        is: 'lens-input-enigma',

        properties: {

          /**
           * Output data as JSON Array
           * @type Array
           * @default []
           */
          output: {
            type: Array,
            value: [],
            notify: true,
            readOnly: true,
            observer: '_outputChanged'
          },

          /**
           *  Register for an API Key at enigma.io
           *
           *  @property apiKey
           *  @type String
           */
          apiKey: {
            type: String,
            value: 'iTX3qf5cwspm7ryII3ii5zqeHqUuoO4MctfLJFf2xU8eletxHvcI4'
          },

          /**
           *  Path to the data set you wish to access through enigma.io.
           *  Examples include:
           *  - 'us.gov.atf.federal-firearms-licenses.complete-listing'
           *  - 'us.gov.whitehouse.salaries.2011'
           *  - 'us.gov.whitehouse.visitor-list'
           *
           *  @property dataSet
           *  @type String
           */
          dataSet: {
            type: String,
            value: 'us.gov.atf.federal-firearms-licenses.complete-listing'
            //'us.gov.whitehouse.salaries.2011', //'us.gov.whitehouse.visitor-list',
          },

          _columns: {
            type: Array,
            value: []
          },

          /**
           *  Enigma can return all columns, or just selected columns.
           *  
           *  @property _selectedCols
           *  @type Array
           *  @default [ ]
           */
          _selectedCols: {
            type: Array,
            value: [],
            notify: true,
            observer: '_selectedColsChanged'
          },

          /**
           *  Enigma can apply a function on the data it returns.
           *  
           *  @property _selectedFunc
           *  @type Array
           *  @default ['frequency']
           */
          _selectedFunc: {
            type: Array,
            value: ['frequency'],
            notify: true,
            readOnly: true
          },

          _errorMsg: {
            type: String,
            value: ''
          },

          hasData: {
            type: Boolean,
            value: false
          },

          _ENIGMA_API_PATH: {
            type: String,
            value: 'https://api.enigma.io/v2',
            readOnly: true
          },

          _META_PATH: {
            type: String,
            value: '/meta/',
            readOnly: true
          },

          _STATS_PATH: {
            type: String,
            value: '/stats/',
            readOnly: true
          },

          _DATA_PATH: {
            type: String,
            value: '/data/',
            readOnly: true
          }
        },


        attached: function() {
          var self = this;

          self.async(function() {
            self._queryMetaData();
          }, 1);
        },

        dataSetChanged: function() {
          this._queryMetaData();
        },

        _queryMetaData: function() {

          var self = this;
          var url = self._ENIGMA_API_PATH+self._META_PATH+self.apiKey+'/'+self.dataSet+'?select=namefull&operation=frequency';
          self._makeCORSCall(url, self._displayMetaData);

        },

        _queryStatData: function() {

          var self = this;
          var url = self._ENIGMA_API_PATH;
          if(self._selectedCols === 'all') {
            url = url +self._DATA_PATH+self.apiKey+'/'+self.dataSet;
          }
          else {
            url = url + self._STATS_PATH+self.apiKey+
                      '/'+self.dataSet+
                      '?select='+self._selectedCols+
                      '&operation='+self._selectedFunc;
          }
          console.log(url);
          self._makeCORSCall(url, self._displayReturnedData);

        },

        _displayReturnedData: function(data) {
            var self = this;
            if(data.success) {
             self.hasData = true;
             console.log(data);
             console.log('data.success', data.success);
             console.log('data.result', data.result);

             if(data.result.frequency) {
                self._triggerOutput( data.result.frequency );
             }
             else if (self._selectedCols==='all') {
                //when all data is selected
                /*
                for(key in data.result) {
                  if(key==0) {
                    var keys = [];
                    for(var k in data.result[key]) keys.push(k);
                   // self.output.push(keys);
                  }
                  var vals = [];
                  for(var k in data.result[key]) vals.push(data.result[key][k]);
                  self.output.push(vals);
                }
                */
               
               self._triggerOutput( data.result );

             }
             else {
                for(key in data.result) {
                  if(key!='success') {
                    self._triggerOutput( [{'column': data.info.column.label , key :data.result[key]}] );
                  }
                }

             }
            
             self._errorMsg = null;
            }
            else {
              self.hasData = false;
              self._errorMsg = data.info.additional;
            }

            // should be its own component...
            //self._createChartData(data);

            //console.log(self.output);

        },

        _displayMetaData: function(data) {
            var self = this;
            self._columns = data.result.columns;

            self._columns.unshift({id: 'all',label: 'All Data (columns)'});


        },

        _makeCORSCall: function(url, mycallback) {

            var self = this;
            var method = 'GET';
            var xhr = new XMLHttpRequest();
            if ('withCredentials' in xhr) {
              xhr.open(method, url, true);
            } else if (typeof XDomainRequest != 'undefined') {
              xhr = new XDomainRequest();
              xhr.open(method, url);
            } else {
              // CORS not supported.
              xhr = null;
            }

            if (!xhr) {
              alert('CORS not supported');
              return;
            }

            // Response handlers.
            xhr.onload = function() {

              var data = JSON.parse(xhr.response);
              mycallback.call(self, data);
              //self._displayReturnedData(data);

            };

            xhr.onerror = function() {
              alert('Woops, there was an error making the request.');
            };

            xhr.send();
            console.log('request sent');
        },

      /**
       *  The `lens-output-changed` event is fired whenever changes are observed in `output` 
       *  @event lens-output-changed
       */
        _outputChanged: function(newValue, oldValue){
          this.fire('lens-output-changed', this.output);
        },

        _triggerOutput: function( val ) {
          this._setOutput(val);
        },

        _selectedColsChanged: function(v) {
        }

      });

  </script>